From aa4a8c2a2a67545e90c877162c53cc9de42dc8b4 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Tue, 24 Apr 2018 16:31:27 +0100
Subject: [PATCH binutils] Fix CVE-2018-10534

The _bfd_XX_bfd_copy_private_bfd_data_common function in peXXigen.c in the
Binary File Descriptor (BFD) library (aka libbfd), as distributed in GNU
Binutils 2.30, processes a negative Data Directory size with an unbounded loop
that increases the value of (external_IMAGE_DEBUG_DIRECTORY) *edd so that the
address exceeds its own memory region, resulting in an out-of-bounds memory
write, as demonstrated by objcopy copying private info with
_bfd_pex64_bfd_copy_private_bfd_data_common in pex64igen.c.

This patch fix an illegal memory access when copying a PE format file with
corrupt debug information.

	PR 23110
	* peXXigen.c (_bfd_XX_bfd_copy_private_bfd_data_common): Check for
	a negative PE_DEBUG_DATA size before iterating over the debug data.
---
 bfd/ChangeLog  |    6 +
 bfd/peXXigen.c |    9 +
 bfd/po/bfd.pot | 5631 ++++++++++++++++++++++++++------------------------------
 3 files changed, 2662 insertions(+), 2984 deletions(-)

diff --git a/bfd/peXXigen.c b/bfd/peXXigen.c
index bc97984..32ce195 100644
--- a/bfd/peXXigen.c
+++ b/bfd/peXXigen.c
@@ -2993,6 +2993,15 @@ _bfd_XX_bfd_copy_private_bfd_data_common (bfd * ibfd, bfd * obfd)
 		 (uint64_t) (section->size - (addr - section->vma)));
 	      return FALSE;
 	    }
+	  /* PR 23110.  */
+	  else if (ope->pe_opthdr.DataDirectory[PE_DEBUG_DATA].Size < 0)
+	    {
+	      /* xgettext:c-format */
+	      _bfd_error_handler
+		(_("%pB: Data Directory size (%#lx) is negative"),
+		 obfd, ope->pe_opthdr.DataDirectory[PE_DEBUG_DATA].Size);
+	      return FALSE;
+	    }
 
 	  for (i = 0; i < ope->pe_opthdr.DataDirectory[PE_DEBUG_DATA].Size
 		 / sizeof (struct external_IMAGE_DEBUG_DIRECTORY); i++)
-- 
2.9.3


