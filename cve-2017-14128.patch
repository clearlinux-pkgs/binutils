From 6bdd6269844b3dd73dd57f9d361c0bebe7f2778a Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Fri, 1 Sep 2017 11:22:43 +0100
Subject: [PATCH 1/1] Prevent an address violation parsing corrupt DWARF
 information by fixing the test for an overlong debug line info structure.

        PR 22059
        * dwarf2.c (decode_line_info): Fix test for an overlong line info
        structure.
---
diff --git a/bfd/dwarf2.c b/bfd/dwarf2.c
index 04a2585..8779627 100644
--- a/bfd/dwarf2.c
+++ b/bfd/dwarf2.c
@@ -2073,12 +2073,12 @@ decode_line_info (struct comp_unit *unit, struct dwarf2_debug *stash)
       offset_size = 8;
     }
 
-  if (lh.total_length > stash->dwarf_line_size)
+  if (unit->line_offset + lh.total_length > stash->dwarf_line_size)
     {
       _bfd_error_handler
 	/* xgettext: c-format */
-	(_("Dwarf Error: Line info data is bigger (0x%lx) than the section (0x%lx)"),
-	 (long) lh.total_length, (long) stash->dwarf_line_size);
+	(_("Dwarf Error: Line info data is bigger (%#Lx) than the space remaining in the section (%#Lx)"),
+	 lh.total_length, stash->dwarf_line_size - unit->line_offset);
       bfd_set_error (bfd_error_bad_value);
       return NULL;
     }
-- 
2.9.3

